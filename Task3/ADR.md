### **Название задачи:** ADR-001 — MVP “Открытие депозитов и накопительных счетов онлайн” (концептуальная архитектура)
### **Автор:** Юрий З.
### **Дата:** 2025-12-25

---

### **Функциональные требования**

| **№** | **Действующие лица или системы** | **Use Case** | **Описание** |
| :-: | --- | --- | --- |
| 1 | Клиент (существующий), Интернет-банк, SMS, Бэк-офис депозитов, АБС | Подача заявки на депозит в интернет-банке | 1) Клиент выбирает депозит и видит актуальные/персональные ставки.<br>2) Вводит сумму и счёт списания.<br>3) Подтверждает операцию СМС-кодом (текущий механизм интернет-банка).<br>4) Создаётся “заявка на открытие депозита” со статусом “На рассмотрении”.<br>5) Менеджер бэк-офиса рассматривает и подтверждает условия в АБС (MVP).<br>6) Клиент получает СМС “ставка подтверждена”.<br>7) После открытия депозита — СМС “депозит открыт”.<br><br>Исключения: неверный СМС-код; временная недоступность сервиса заявок; превышение лимитов/валидации (сумма/счёт). |
| 2 | Новый клиент, Сайт, Кол-центр, Отделение | Заявка на депозит на сайте (лидогенерация) | 1) Клиент на сайте видит список депозитов с актуальными ставками.<br>2) Оставляет ФИО и телефон.<br>3) Создаётся лид в системе кол-центра.<br>4) Менеджер кол-центра звонит, может предложить особые условия и фиксирует исход.<br>5) Клиент приглашён в отделение для идентификации (обязательное условие для новых клиентов).<br><br>Исключения: неверный номер; клиент не дозвонился; отказ клиента. |
| 3 | Бэк-офис депозитов, АБС, SMS | Подтверждение ставки по заявке (MVP) | 1) Менеджер бэк-офиса открывает заявку (из очереди заявок).<br>2) Подтверждает ставку/условия в АБС (MVP работает “по старому процессу”).<br>3) Запускается уведомление клиенту “ставка подтверждена”. |
| 4 | Бэк-офис депозитов, АБС, SMS | Открытие депозита по заявке (MVP) | 1) Менеджер создаёт депозит в АБС.<br>2) Документы формируются/подписываются по текущим правилам (в рамках MVP).<br>3) Клиент получает СМС “депозит открыт”. |
| 5 | Бэк-офис кредитов, Бэк-офис депозитов | Расчёт/согласование специальных ставок (как ограничение) | 1) При необходимости специальных условий депозиты запрашивают данные у кредитов.<br>2) Кредиты передают только допустимые показатели/результаты (без раскрытия запрещённых данных).<br>3) Депозиты фиксируют согласованную ставку. (В MVP допускается сохранение текущего подхода, но требуется целевая автоматизация на горизонте года). |

---

### **Нефункциональные требования**

| **№** | **Требование** |
| :-: | --- |
| N1 | Доступность 24/7, целевая доступность 99,9% для онлайн-каналов и нового функционала. |
| N2 | Отказоустойчивость между 2 ЦОД: при сбое одного ЦОД сервисы продолжают работу (минимум: управляемый failover). |
| N3 | Производительность: операции чтения ставок/списков — “миллисекунды” (целевой p95 ≤ 200–300 мс), исключить загрузку справочников > 1 сек. |
| N4 | Защита данных: шифрование трафика (TLS) для сайта и интернет-банка, т.к. передаётся чувствительная информация (ФИО/телефон/параметры заявки). |
| N5 | Нельзя повторять прямой доступ интернет-банка к БД АБС в новом процессе. |
| N6 | АБС БД перегружена: архитектура должна защищать АБС от массовых онлайн-запросов (кэш/буферизация/асинхронность/адаптер). |
| N7 | Использовать преимущественно существующие технологии (MS SQL/Oracle), новые — совместимые и с внутренней экспертизой. |
| N8 | Наблюдаемость: централизованные логи/метрики/корреляция по request-id для сценариев заявок и уведомлений. |
| N9 | Аудит действий: кто/когда подтвердил условия, кто открыл депозит, кто изменил ставку. |
| N10 | Без доработок SMS-ядра интернет-банка подрядчиком: используем текущий механизм подтверждения в ИБ как есть. |
| N11 | Безопасность оргразделения: депозиты и кредиты не должны получать запрещённый доступ к данным друг друга. |

---

### **Решение**

#### 1) Диаграммы C4 (файлы в папке Task3)
- C4 Context: `Task3/c4-context.png` (исходник `Task3/c4-context.drawio`)
- C4 Container: `Task3/c4-container.png` (исходник `Task3/c4-container.drawio`)

> Диаграммы загружены отдельными файлами.

#### 2) Концептуальная архитектура MVP (что добавляем и зачем)

**Ключевой принцип MVP:** онлайн-каналы (сайт/интернет-банк) не должны ходить “напрямую” в БД АБС. Мы вводим “интеграционный/прикладной слой” для заявок и ставок, который:
- принимает заявки из сайта и интернет-банка,
- хранит их в отдельном хранилище (не в БД АБС),
- отдаёт данные бэк-офису для обработки,
- интегрируется с АБС через контролируемый адаптер (не напрямую из интернет-банка),
- обеспечивает 24/7 и 99,9% за счёт правильного развертывания в 2 ЦОД.

**Участвующие системы/команды (из задания):**
- Сайт (PHP + React) — команда сайта.
- Интернет-банк (ASP.NET MVC 4.5 + MS SQL, монолит на платформе подрядчика) — команда ИБ (банк + подрядчик).
- АБС (Delphi + Oracle + PL/SQL) — команда АБС.
- Система кол-центра (React + Java Spring Boot + PostgreSQL, микросервисы) — подрядчик кол-центра + иногда специалисты банка.
- СМС-шлюз/телеком — поддержка IT-отдела.

#### 3) Контейнеры/сервисы (логические блоки решения)

**Новые контейнеры (MVP):**
1) **Deposit Applications Service (DAS)** — сервис заявок (API).
   - Функции: создать заявку (из сайта/ИБ), хранить статусы, отдавать очередь заявок бэк-офису.
   - Хранилище: MS SQL или Oracle (предпочтительно из “имеющихся технологий”).

2) **Rates & Products Service (RPS)** — справочник депозитных продуктов и ставок (актуальные + персональные).
   - Функции: отдавать список депозитов/ставок сайту и ИБ; хранить версии ставок; поддержать загрузку/обновление ставок (пока можно импортом из XLS как промежуточный шаг).
   - Важно: роль/права доступа для депозитов и кредитов + аудит.

3) **Back-office Workbench (BOW)** — интерфейс/кабинет для бэк-офиса (может быть простым web-приложением).
   - Функции: просмотр заявок, решение по заявке, триггер “подтверждено в АБС / депозит открыт”.

4) **ABS Adapter (controlled)** — адаптер к АБС.
   - Единственный компонент, который имеет доступ к интеграции с АБС (Oracle / процедуры / регламентированные методы).
   - Защищает АБС: лимитирует, ставит очередь, ретраи, не даёт “онлайн шквал” запросов.

**Используемые контейнеры “как есть”:**
- Интернет-банк (web + backend монолит + MS SQL) — подтверждение СМС остаётся в ядре ИБ.
- АБС (Delphi client + Oracle DB + PL/SQL) — окончательное подтверждение/открытие депозита (MVP).
- Кол-центр — обработка лидов сайта.

#### 4) Интеграции (протоколы/форматы — на уровне концепта)

- Сайт → DAS/RPS: HTTPS + JSON (создание заявки / получение ставок).
- Интернет-банк → DAS/RPS: HTTPS + JSON.
- DAS ↔ BOW: HTTPS + JSON (очередь/статусы).
- DAS/BOW → ABS Adapter: HTTPS + JSON (или внутренний RPC), адаптер далее работает с Oracle/PLSQL согласно правилам команды АБС.
- Кол-центр: лиды сайта можно либо писать напрямую в систему кол-центра (если есть внутренние API), либо через DAS как “единый вход” и дальше маршрутизировать в КЦ.

> Допущение: конкретные API кол-центра и АБС не описаны в задании, поэтому выше — концептуально (HTTP/JSON + адаптер/очередь).

#### 5) Как “уйти от прямого доступа интернет-банка к базе АБС”
- Запрещаем ИБ прямой доступ к Oracle/таблицам АБС.
- ИБ работает только с DAS/RPS по HTTPS.
- Любые действия в АБС — через ABS Adapter, который контролирует нагрузку и имеет отдельный контур доступа.

#### 6) Как обеспечить 24/7 и 99,9% в условиях 2 ЦОД (концептуально)
- Развернуть DAS/RPS/BOW/Adapter в 2 ЦОД (active-active или active-standby).
- Внешний балансировщик (GSLB/LB) распределяет запросы и обеспечивает failover.
- БД сервисов: репликация (например, MS SQL AlwaysOn / Oracle Data Guard) и чёткие RPO/RTO.
- Кэширование ставок/справочников для скорости и снижения нагрузки.
- Circuit breaker/таймауты/деградация: если АБС недоступна, заявки принимаем, но переводим в статус “ожидает обработки”.

---

### **Альтернативы**

1) Оставить как есть: интернет-банк напрямую в БД АБС — быстро, но усиливает риск отказа и нагрузку на перегруженную БД (не подходит).
2) Прямой online-API к АБС из интернет-банка — лучше чем БД, но всё равно создаёт “онлайн-нагрузку” и нарушает принцип защиты АБС.
3) Полная микросервисная трансформация ИБ + Kafka сразу — стратегически хорошо, но есть ограничение: текущая платформа ИБ несовместима с Kafka; для MVP риск по срокам.

---

**Недостатки, ограничения, риски**

- Добавление новых сервисов увеличивает сложность эксплуатации (нужны мониторинг/логирование/дежурства).
- Интеграция с АБС через адаптер требует участия команды АБС и согласования контрактов.
- Если ставки остаются в XLS слишком долго — риск ошибок и ручного труда; нужен план миграции ставок в RPS/АБС на горизонте года.
